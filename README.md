# CompressAI `bmshj2018_factorized` ãƒ‡ã‚³ãƒ¼ãƒ€ç½®æ› & è’¸ç•™â†’é€šå¸¸FTï¼ˆCOCO-trainï¼‰

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€**CompressAI** ã® `bmshj2018_factorized` ã‚’æ•™å¸«ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã€
ãƒ‡ã‚³ãƒ¼ãƒ€å†…ã® **ConvTranspose2d** ã‚’ **Upsample + Conv2d** ã«ç½®æ›ã—ãŸ **å­¦ç”Ÿãƒ¢ãƒ‡ãƒ«ï¼ˆStudentï¼‰** ã‚’ä½œæˆã—ã€
ã¾ãš **çŸ¥è­˜è’¸ç•™**ï¼ˆTeacherå‡ºåŠ›ã«StudentãŒè¿‘ã¥ãï¼‰ã§å­¦ç¿’ã€ãã®å¾Œ **é€šå¸¸ã®å†æ§‹æˆæœ€é©åŒ–ï¼ˆå¯¾GTï¼‰ã§FT** ã‚’è¡Œã†ãƒ¬ã‚·ãƒ”ã§ã™ã€‚

- ç”»åƒã‚µã‚¤ã‚º: **224Ã—224**
- ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ: **COCO 2017 train**ï¼ˆç”»åƒã®ã¿ä½¿ç”¨ã€‚ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸è¦ï¼‰
- å®Ÿè¡Œç’°å¢ƒ: **Google Colab Pro** ã‚’æƒ³å®š

---

## ã§ãã‚‹ã“ã¨ï¼ˆæ›´æ–°ï¼‰
- ğŸ” **å±¤ç½®æ›**: `ConvTranspose2d â†’ Upsample(scale=2) + Conv2d(kernel=5, padding=2)` ã‚’ãƒ‡ã‚³ãƒ¼ãƒ€ `g_s` ã«è‡ªå‹•é©ç”¨  
- ğŸ§Š **é¸æŠçš„å¾®èª¿æ•´**: ç½®æ›Convã®ã¿å­¦ç¿’ï¼ˆæ—¢å®šï¼‰ï¼IGDNã‚‚å­¦ç¿’ï¼ˆ`--train_igdn`ï¼‰ï¼å…¨å±¤è§£å‡ï¼ˆ`--unfreeze_all`ï¼‰
- ğŸ“ **çŸ¥è­˜è’¸ç•™**: Teacherå†æ§‹æˆã«StudentãŒè¿‘ã¥ãã‚ˆã† **L1 + (1 âˆ’ MS-SSIM)** ã‚’æœ€å°åŒ–
- ğŸ–¼ï¸ **å†æ§‹æˆã®ä¿å­˜ï¼ˆé‡è¦ï¼‰**:  
  - **å­¦ç¿’é–‹å§‹å‰**ã¨ **æ—¢å®š5ã‚¨ãƒãƒƒã‚¯ã”ã¨**ã«ã€**valç”»åƒã® Student å†æ§‹æˆã®ã¿**ã‚’PNGã§ä¿å­˜  
  - ç¢ºèªã«ç”¨ã„ã‚‹valç”»åƒã¯ **å…ˆé ­ã‹ã‚‰å›ºå®šã®ã‚µãƒ–ã‚»ãƒƒãƒˆ**ï¼ˆæ—¢å®š16æšï¼‰ã€‚**å®Ÿè¡Œä¸­ã¯ä¸å¤‰**  
  - ä¿å­˜å…ˆ: è’¸ç•™ã¯ `save_dir/recon/<tag>/00000.png ...`ã€FTã¯ `save_dir/recon_ft/<tag>/...`  
  - `tag` ä¾‹: `pre_e000`, `e004`, `e009`, â€¦ï¼ˆã‚¨ãƒãƒƒã‚¯0å§‹ã¾ã‚Šè¡¨è¨˜ï¼‰
- ğŸ“Š **W&Bå¯è¦–åŒ–**ï¼ˆä»»æ„ï¼‰: ãƒ­ã‚¹ãƒ»PSNRãƒ»MS-SSIMãƒ»LRãƒ»**Studentå†æ§‹æˆã®ã‚°ãƒªãƒƒãƒ‰ç”»åƒ** ã‚’ãƒ­ã‚°
- ğŸ’¾ **ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ**: æ¯ã‚¨ãƒãƒƒã‚¯ `last.pt`ã€æ¤œè¨¼MS-SSIMãƒ™ã‚¹ãƒˆ `best_msssim.pt`ï¼ˆè’¸ç•™ï¼‰/ `ft_best.pt`ï¼ˆFTï¼‰
- ğŸ§° **å‰å‡¦ç†**: COCO train2017 ã® **DL/å±•é–‹**ã€ä»»æ„ã§ **224ã‚¯ãƒ­ãƒƒãƒ—ã‚’äº‹å‰ä½œæˆ**
- ğŸ““ **Colabãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯**: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—â†’ãƒ‡ãƒ¼ã‚¿æº–å‚™â†’å­¦ç¿’â†’è©•ä¾¡ã¾ã§

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```
src/
  custom_decoder.py        # ç½®æ›ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆJPã‚³ãƒ¡ãƒ³ãƒˆï¼‰
  dataset_coco.py          # COCOç”»åƒã‚’224ã«ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚ªãƒ³ã‚¶ãƒ•ãƒ©ã‚¤/äº‹å‰ã‚¯ãƒ­ãƒƒãƒ—ä¸¡å¯¾å¿œï¼‰
  losses.py                # L1, MS-SSIM, PSNR
  train_distill.py         # è’¸ç•™å­¦ç¿’ï¼ˆStudentâ†”Teacherï¼‰ + Studentå†æ§‹æˆä¿å­˜
  eval.py                  # æ¤œè¨¼ï¼ˆPSNR/MS-SSIMï¼‰
scripts/
  coco_prepare.py          # COCO train2017 ã®DL/å±•é–‹ & 224ã‚¯ãƒ­ãƒƒãƒ—ï¼ˆä»»æ„ï¼‰
checkpoints/               # è’¸ç•™ã®ä¿å­˜å…ˆï¼ˆä¾‹ï¼‰
checkpoints_ft/            # FTã®ä¿å­˜å…ˆï¼ˆä¾‹ï¼‰
finetune_after_distill.py  # è’¸ç•™å¾Œã®é€šå¸¸FTï¼ˆStudentâ†”GTï¼‰ + Studentå†æ§‹æˆä¿å­˜
fine_tune_bmshj2018_coco_colab.ipynb  # Colabãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯
```

---

## Colabã§ã®æ‰‹é †ï¼ˆæ¦‚è¦ï¼‰
1. ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ `fine_tune_bmshj2018_coco_colab.ipynb` ã‚’é–‹ã  
2. **ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**ã‚»ãƒ«ã‚’å®Ÿè¡Œï¼ˆä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰  
3. **ãƒ‡ãƒ¼ã‚¿æº–å‚™**ã‚»ãƒ«ã‚’å®Ÿè¡Œï¼ˆCOCO train2017 ã‚’DLï¼†å±•é–‹ã€‚å¿…è¦ã«å¿œã˜ã¦224ã‚¯ãƒ­ãƒƒãƒ—ã‚’äº‹å‰ç”Ÿæˆï¼‰  
4. **è’¸ç•™å­¦ç¿’**ã‚»ãƒ«ã‚’å®Ÿè¡Œï¼ˆW&Bã¯ä»»æ„ï¼‰  
5. **FTå­¦ç¿’**ã‚»ãƒ«ã‚’å®Ÿè¡Œï¼ˆè’¸ç•™ã®ãƒ™ã‚¹ãƒˆckptã‹ã‚‰ç¶™ç¶šï¼‰  
6. **è©•ä¾¡**ã‚»ãƒ«ã‚’å®Ÿè¡Œï¼ˆPSNR / MS-SSIM ã‚’è¡¨ç¤ºï¼‰  

> âš ï¸ COCO train2017 ã¯å®¹é‡ãŒå¤§ãã„ï¼ˆ~18GBï¼‰ãŸã‚ã€Colabã®ä¸€æ™‚ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚  
> çœãƒ¡ãƒ¢ãƒªãƒ»çœã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã¯ã€`--max_images` ã§ä½¿ç”¨æšæ•°ã‚’åˆ¶é™ã§ãã¾ã™ã€‚

---

## å­¦ç¿’ãƒ¬ã‚·ãƒ”ï¼ˆæ—¢å®šï¼‰
- Teacher: `compressai.zoo.pretrained.bmshj2018_factorized(quality=8)`
- Student: Teacheré‡ã¿ã§åˆæœŸåŒ– â†’ ãƒ‡ã‚³ãƒ¼ãƒ€`g_s`ã®ConvTranspose2dã‚’ **Upsample+Conv2d** ã«ç½®æ›
- å¾®èª¿æ•´ç¯„å›²: ç½®æ›Convã®ã¿ï¼ˆ`--train_igdn`ã§IGDNã‚‚ã€`--unfreeze_all`ã§å…¨å±¤ï¼‰
- æå¤±: `Î»1 * L1 + Î»2 * (1 - MS-SSIM)`ï¼ˆæ—¢å®š Î»1=1.0, Î»2=0.2ï¼‰
- Optimizer: Adam (lr=1e-4), CosineAnnealingLR
- ãƒãƒƒãƒ: 16ï¼ˆColab T4/A100æƒ³å®šã€é©å®œèª¿æ•´ï¼‰
- ã‚¨ãƒãƒƒã‚¯: 10ã€œ30ç›®å®‰ï¼ˆæ‰“ã¡åˆ‡ã‚Šå¯ï¼‰

---

## ä»£è¡¨çš„ãªã‚³ãƒãƒ³ãƒ‰

### 1) 224ã‚¯ãƒ­ãƒƒãƒ—ã‚’äº‹å‰ç”Ÿæˆã—ã¦ã‹ã‚‰å­¦ç¿’ï¼ˆä»»æ„ï¼‰
```bash
python -m scripts.coco_prepare \
  --coco_dir /content/data/coco \
  --out_dir /content/data/coco224 \
  --val_ratio 0.02
```

### 2) è’¸ç•™ï¼ˆStudentâ†”Teacherã€Studentå†æ§‹æˆã®ã¿ä¿å­˜ï¼‰
```bash
python src/train_distill.py \
  --coco_dir /content/data/coco224 \
  --use_prepared true \
  --quality 8 --epochs 15 --batch_size 16 --lr 1e-4 \
  --recon_every 5 --recon_count 16 --recon_subdir recon \
  --wandb_project bmshj2018_ft_coco \
  --save_dir ./checkpoints
```
- **å†æ§‹æˆä¿å­˜**: å­¦ç¿’å‰ã¯ `./checkpoints/recon/pre_e000/`ã€ä»¥é™ `e004/`, `e009/` â€¦ ã« **Studentå‡ºåŠ›ã®ã¿** ã‚’PNGä¿å­˜  
- **W&B**: `recon/<tag>` ã¨ã—ã¦ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ãƒ­ã‚°ï¼ˆä»»æ„ï¼‰

### 3) è’¸ç•™ã®ç¶šãã‹ã‚‰å†é–‹
```bash
python src/train_distill.py \
  --coco_dir /content/data/coco224 \
  --use_prepared true \
  --resume ./checkpoints/last.pt
```

### 4) è’¸ç•™å¾Œã®é€šå¸¸FTï¼ˆStudentâ†”GTã€Studentå†æ§‹æˆã®ã¿ä¿å­˜ï¼‰
```bash
python finetune_after_distill.py \
  --coco_dir /content/data/coco224 \
  --use_prepared true \
  --quality 8 --epochs 10 --batch_size 16 --lr 1e-4 \
  --resume_student ./checkpoints/best_msssim.pt \
  --recon_every 5 --recon_count 16 --recon_subdir recon_ft \
  --wandb_project bmshj2018_ft_coco \
  --save_dir ./checkpoints_ft
```
- **å‡çµæ–¹é‡**: Student ä»¥å¤–ã¯å…¨å‡çµã€‚`--freeze_igdn` ã§ Student å†…ã® IGDN/GDN ã‚’å‡çµå¯èƒ½  
- **ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ**: `./checkpoints_ft/ft_last.pt`, `./checkpoints_ft/ft_best.pt`  
- **å†æ§‹æˆä¿å­˜**: `./checkpoints_ft/recon_ft/<tag>/00000.png ...` ã« **Studentå‡ºåŠ›ã®ã¿** ã‚’ä¿å­˜

### 5) è©•ä¾¡ï¼ˆä¾‹ï¼šPSNR/MS-SSIMï¼‰
```bash
python -m src.eval \
  --coco_dir /content/data/coco224 \
  --checkpoint ./checkpoints/best_msssim.pt
```

---

## å†æ§‹æˆä¿å­˜ã®ä»•æ§˜ï¼ˆé‡è¦ï¼‰
- **ä¿å­˜å¯¾è±¡**: **Student ã®å†æ§‹æˆã®ã¿**ï¼ˆå…¥åŠ›ã‚„Teacherã¯ä¿å­˜ã—ã¾ã›ã‚“ã€‚å…¥åŠ›/Teacherã¯æ±ºå®šçš„ã§å†—é•·ãªãŸã‚ï¼‰  
- **ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: å­¦ç¿’ **é–‹å§‹å‰** ã¨ã€`--recon_every`ï¼ˆæ—¢å®š5ï¼‰ã‚¨ãƒãƒƒã‚¯ã”ã¨  
- **å¯¾è±¡ç”»åƒ**: valã‚»ãƒƒãƒˆå…ˆé ­ã‹ã‚‰ `--recon_count`ï¼ˆæ—¢å®š16ï¼‰æšã‚’ **å›ºå®šã‚µãƒ–ã‚»ãƒƒãƒˆ** ã¨ã—ã¦ä½¿ç”¨ï¼ˆ**å®Ÿè¡Œä¸­ã¯å¤‰æ›´ã—ãªã„**ï¼‰  
- **å‡ºåŠ›å½¢å¼**: 1ã‚µãƒ³ãƒ—ãƒ«=1PNGï¼ˆ`00000.png` ã‹ã‚‰é€£ç•ªï¼‰  
- **å‡ºåŠ›å…ˆ**: è’¸ç•™ã¯ `save_dir/recon/<tag>/`ã€FTã¯ `save_dir/recon_ft/<tag>/`

> ãƒ¡ãƒ¢: `dataset_coco.py` ã®åˆ†å‰²ã¯ãƒ•ã‚¡ã‚¤ãƒ«åãƒãƒƒã‚·ãƒ¥ã«åŸºã¥ãæ±ºå®šçš„åˆ†å‰²ã§ã™ã€‚`recon_count` ã«ã‚ˆã‚‹å›ºå®šã‚µãƒ–ã‚»ãƒƒãƒˆã‚‚ã€åŒä¸€è¨­å®šãƒ»åŒä¸€ãƒ‡ãƒ¼ã‚¿ç’°å¢ƒã§ã¯å†ç¾çš„ã«é¸ã°ã‚Œã¾ã™ã€‚

---

## åæŸã®ç›®å®‰ï¼ˆCOCO train2017, 224crop, batch=16, lr=1e-4ï¼‰
- **è’¸ç•™ã®ã¿**: Teacherã«ã»ã¼ä¸€è‡´ï¼ˆPSNRå·® â‰¤0.1dB / MS-SSIM â‰¥0.995ï¼‰ã¾ã§ **ç´„3â€“7ã‚¨ãƒãƒƒã‚¯**  
- **è’¸ç•™å¾ŒFT**: å¯¾GTã§å¾®å·®ã‚’è©°ã‚ã‚‹ã®ã« **+1â€“3ã‚¨ãƒãƒƒã‚¯**  
- **åˆè¨ˆ**: ãŠãŠã‚ˆã **5â€“10ã‚¨ãƒãƒƒã‚¯** ã§TeacheråŒç­‰ã€œåƒ…å·®ä¸Šå›ã‚ŠãŒç›®å®‰ï¼ˆä»¥é™ã¯æ”¹å–„é€“æ¸›ï¼‰

---

## ã‚ˆãã‚ã‚‹Tips
- VRAMã«ä½™è£•ãŒã‚ã‚Œã° **å¤§ãã‚batch** + **AMP** ã§å®‰å®šã‹ã¤é«˜é€ŸåæŸ
- FTæ™‚ã¯ **è’¸ç•™ã¨åŒLRã‹ã€å°‘ã—ä¸‹ã’ã‚‹ï¼ˆ1/2ãªã©ï¼‰** ã¨1â€“2ã‚¨ãƒãƒƒã‚¯ã§è©°ã¾ã‚Šã‚„ã™ã„
- `--max_images` ã§ã‚µãƒ–ã‚µãƒ³ãƒ—ãƒ«ã™ã‚‹å ´åˆã¯ã€å¿…è¦ã‚¨ãƒãƒƒã‚¯æ•°ãŒè‹¥å¹²å¢—ãˆã‚‹å‚¾å‘

---

## ç’°å¢ƒãƒ¡ãƒ¢
- W&Bã‚’ä½¿ã‚ãªã„å ´åˆã¯ `WANDB_DISABLED=true` ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚  
- è¿½åŠ æŒ‡æ¨™ï¼ˆLPIPSãªã©ï¼‰ã¯è¨ˆç®—ã‚³ã‚¹ãƒˆãŒå¢—ãˆã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µã—ã¦ãã ã•ã„ã€‚

